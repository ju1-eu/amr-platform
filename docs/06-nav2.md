---
title: "Phase 6 – Nav2: Navigation auf Karte (map)"
type: "phase-doc"
file: "docs/06-nav2.md"
version: "v0.1.0"
status: "draft"
updated: "2025-12-21"
scope: "Projekt-Nachschlagewerk für den AMR-Betrieb (Engineering-Referenz, kein Hochschul-Skript)"
depends_on:
  - "Phase 2 (Docker ROS 2 Humble auf Pi 5) ✅"
  - "Phase 3 (RPLidar A1 + /scan) ✅"
  - "Phase 4 (URDF + TF + /odom) ⬜"
  - "Phase 5 (SLAM: /map + map→odom ODER gespeicherte Map + AMCL) ⬜"
next:
  - "Betrieb/Validierung: Parameter-Tuning + Safety-Review"
---

# Phase 6 – Nav2: Navigation auf Karte (map)

## 0) Ziel und Regel der Phasen-Dokumentation

### Ziel

Phase 6 liefert den **autonomen Navigationsbetrieb**: In RViz2 wird ein Ziel gesetzt, Nav2 plant (global/lokal), weicht Hindernissen aus und erzeugt `/cmd_vel`, das der Low-Level-Stack zuverlässig in Bewegung umsetzt.

### Regel (Scope-Grenze)

- Betriebsziel, Datenverträge (TF/Topics), Startmodi, minimale Projektablage, Smoke-Checks, typische Fehlerbilder, DoD.

---

## 1) Zielbild (Outcome)

- RViz2: Ziel setzen (**Nav2 Goal**), optional Initialpose (**2D Pose Estimate**) im Localization-Modus.
- Nav2 publiziert `/cmd_vel` und der Rover fährt **plausibel** zum Ziel und stoppt zuverlässig.
- Hindernisse werden über Costmaps berücksichtigt (LaserScan als Quelle).
- Betrieb ist reproduzierbar über ein Repo-eigenes Bringup (Launch + Param-Datei).

---

## 2) Definition of Done (DoD) – prüfbar

- [ ] Nav2 startet stabil im Docker-ROS auf Pi 5 (keine „inactive“ Server, keine TF-Fehler-Spam)
- [ ] TF-Kette ist vollständig: `map → odom → base_link → laser` (oder `base_footprint` statt `base_link`, aber konsistent)
- [ ] RViz2 zeigt Map + Scan + TF konsistent (Scan liegt plausibel in der Karte)
- [ ] „Nav2 Goal“ erzeugt `/cmd_vel` und der Roboter bewegt sich plausibel
- [ ] Failsafe bleibt wirksam (Kommunikationsabbruch → Stop innerhalb des definierten Timeouts)
- [ ] `amr_bringup/` enthält versioniert: `nav2_params.yaml`, Launchfile, RViz-Config, Maps (falls genutzt)

---

## 3) Datenverträge (Minimum, müssen stabil sein)

### 3.1 TF-Frames (Minimum)

- `map → odom`
  Quelle: **SLAM Toolbox** (Modus A) oder **AMCL** (Modus B)
- `odom → base_footprint` (oder `odom → base_link`)
  Quelle: Odom-Bridge oder `robot_localization`
- `base_footprint → base_link → laser` (statisch)
  Quelle: URDF + `robot_state_publisher`

**Regel:** Pro TF-Kante genau **eine** Quelle (kein Doppel-Publishing).

### 3.2 Topics (Minimum)

**Nav2 benötigt (Input):**

- `/tf`, `/tf_static`
- `/scan` (`sensor_msgs/LaserScan`)
- `/odom` (`nav_msgs/Odometry`)
- `/map` (`nav_msgs/OccupancyGrid`)
  Quelle: SLAM Toolbox (Modus A) oder Map Server (Modus B)
- `/clock` nur bei `use_sim_time:=true`

**Nav2 liefert (Output):**

- `/cmd_vel` (`geometry_msgs/Twist` oder `TwistStamped`, je nach Setup)

**Projektentscheidung (Kompatibilität):**

- Low-Level akzeptiert **`/cmd_vel`** als primären Eingang.
  Optional: internes Remap/Republish (z. B. `/cmd_vel → /amr/cmd_vel`), aber erst nach stabilem Grundbetrieb.

---

## 4) Voraussetzungen (aus den Phasen)

- Phase 2: Docker-ROS läuft stabil, Devices sind sauber durchgereicht
- Phase 3: `/scan` stabil, plausibel, korrektes `frame_id`
- Phase 4: `/odom` + TF `odom → base_*` + statische URDF-TFs sind konsistent
- Phase 5: entweder
  - **Modus A:** SLAM liefert `/map` + TF `map → odom`, oder
  - **Modus B:** gespeicherte Map + AMCL liefern `/map` + TF `map → odom`

---

## 5) Projektablage (Bringup im Repo)

Empfohlen:

```
ros2_ws/src/amr_bringup/
├─ launch/
│  └─ nav2.launch.py
├─ config/
│  └─ nav2_params.yaml
├─ rviz/
│  └─ nav2.rviz
└─ maps/
├─ amr_map.yaml
└─ amr_map.pgm
```

Ziel: Ein einziger Startpunkt (Launch) für beide Modi.

---

## 6) Modus A – Navigation + SLAM (Live-Mapping)

### 6.1 Zweck

Navigation in neuer Umgebung, SLAM erzeugt `/map` und `map → odom` live.

### 6.2 Startreihenfolge (Real Robot)

1. Low-Level/Bridge + micro-ROS Agent (cmd_vel/odom steht)
2. LiDAR (`/scan`)
3. (Optional) `robot_localization` (wenn genutzt)
4. Nav2-BRINGUP im SLAM-Modus
5. RViz2

### 6.3 Start (Beispiel)

```bash
ros2 launch nav2_bringup bringup_launch.py \
  slam:=True \
  use_sim_time:=False \
  params_file:=/workspaces/ros2_ws/src/amr_bringup/config/nav2_params.yaml \
  use_composition:=True \
  autostart:=true
```

---

## 7) Modus B – Navigation auf gespeicherter Map (AMCL)

### 7.1 Zweck

Wiederholbare Navigation auf bekannter Karte.

### 7.2 Start (Beispiel)

```bash
ros2 launch nav2_bringup bringup_launch.py \
  slam:=False \
  map:=/workspaces/ros2_ws/src/amr_bringup/maps/amr_map.yaml \
  use_localization:=True \
  use_sim_time:=False \
  params_file:=/workspaces/ros2_ws/src/amr_bringup/config/nav2_params.yaml \
  use_composition:=True \
  autostart:=true
```

### 7.3 RViz2 Initialpose

Einmalig **2D Pose Estimate** setzen, danach Goals schicken.

---

## 8) nav2_params.yaml – Minimum, das du anfassen musst

### 8.1 Frames/Topics

- `global_frame: map`
- `odom_frame: odom`
- `base_frame: base_link` (oder `base_footprint`, aber konsistent)
- `scan_topic: /scan`
- `/cmd_vel` Pipeline: so belassen, dass die Firmware sie direkt akzeptiert

### 8.2 Footprint (Start robust)

- Start: Kreis-Footprint (robust)
  Radius als konservativer Startwert, später messen/tunen.

### 8.3 Limits (Start konservativ)

- `max_vel_x`, `max_vel_theta`, Beschleunigungen erst vorsichtig setzen.

---

## 9) Standard-Smoke-Tests (ohne RViz2)

### 9.1 Mindest-Topics

```bash
ros2 topic list | egrep "(/scan|/tf|/odom|/map|/cmd_vel)"
```

### 9.2 TF-Kette

```bash
ros2 run tf2_ros tf2_echo map base_link
ros2 run tf2_ros tf2_echo base_link laser
```

### 9.3 Nav2 Actions

```bash
ros2 action list | egrep "(navigate_to_pose|follow_waypoints)"
```

### 9.4 cmd_vel Output

```bash
ros2 topic echo /cmd_vel --once
```

---

## 10) Typische Fehlerbilder (kurz, diagnostisch)

### 10.1 Costmap „inactive“ / Nav2 startet, navigiert aber nicht

- Ursache fast immer: TF-Kette `map → odom → base_*` fehlt oder springt.
- Primärcheck:

```bash
ros2 run tf2_ros tf2_echo map base_link
```

### 10.2 `/scan` da, aber keine Hindernisse in Costmap

- Laser-Frame passt nicht zum TF-Baum oder `observation_sources`/Topic falsch.

### 10.3 Roboter fährt „falsch herum“ / dreht falsch

- REP-103 Achsenkonvention verletzt oder URDF/TF yaw falsch (Laser/Body).

---

## 11) Sicherheitsanforderung (nicht verhandelbar)

- Failsafe bleibt aktiv, auch wenn Nav2 läuft:

  - Wenn `/cmd_vel` ausbleibt/Kommunikation abbricht: Stop innerhalb des definierten Timeouts.
- Vor „Freifahrt“: Tests mit aufgebockten Rädern + reduzierten Limits.
