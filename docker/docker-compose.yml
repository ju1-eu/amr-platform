# AMR Docker Stack
# Raspberry Pi OS + ROS 2 Jazzy

services:
  # ============================================
  # ROS 2 Perception Stack
  # ============================================
  perception:
    build:
      context: ./perception
      dockerfile: Dockerfile
    image: amr_perception:jazzy
    container_name: amr_perception
    hostname: amr_perception
    network_mode: host
    privileged: true
    restart: unless-stopped
    
    volumes:
      # Geräte-Zugriff
      - /dev:/dev
      - /run/udev:/run/udev:ro
      
      # ROS 2 Workspace (persistent)
      - ./perception/src:/ros_ws/src
      - ./config:/ros_ws/config
      - ./maps:/ros_ws/maps
      - ./launch:/ros_ws/launch
      
      # Kamera-Zugriff (libcamera)
      - /var/run/camera:/var/run/camera
      
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - RCUTILS_COLORIZED_OUTPUT=1
      
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0   # RPLIDAR A1
      - /dev/video0:/dev/video0     # Kamera (falls v4l2)
      - /dev/hailo0:/dev/hailo0     # Hailo-8L
      
    command: >
      bash -c "
        source /opt/ros/jazzy/setup.bash &&
        if [ -f /ros_ws/install/setup.bash ]; then
          source /ros_ws/install/setup.bash
        fi &&
        echo 'ROS 2 Jazzy ready. Use: docker exec -it amr_perception bash' &&
        sleep infinity
      "

  # ============================================
  # micro-ROS Agent (ESP32 Bridge)
  # ============================================
  micro_ros:
    image: microros/micro-ros-agent:jazzy
    container_name: amr_micro_ros
    hostname: amr_micro_ros
    network_mode: host
    privileged: true
    restart: unless-stopped
    
    devices:
      - /dev/ttyACM0:/dev/ttyACM0   # ESP32-S3 XIAO (USB-CDC)
      
    environment:
      - ROS_DOMAIN_ID=0
      
    command: serial --dev /dev/ttyACM0 -b 115200 -v6
    
    # Erst starten wenn perception läuft
    depends_on:
      - perception

